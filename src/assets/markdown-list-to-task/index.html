<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Markdown List to Task</title>
    <style>
      /* Light mode (default) */
      :root {
        --bg-color: #ffffff;
        --text-color: #333333;
        --text-secondary: #666666;
        --border-color: #dddddd;
        --button-bg: #007bff;
        --button-hover: #0056b3;
        --example-bg: #f8f9fa;
        --example-border: #e9ecef;
        --warning-bg: #fff3cd;
        --warning-text: #856404;
        --warning-border: #ffeaa7;
        --textarea-bg: #ffffff;
      }

      /* Dark mode */
      @media (prefers-color-scheme: dark) {
        :root {
          --bg-color: #1e1e1e;
          --text-color: #e0e0e0;
          --text-secondary: #aaaaaa;
          --border-color: #444444;
          --button-bg: #0d6efd;
          --button-hover: #0b5ed7;
          --example-bg: #2d2d2d;
          --example-border: #444444;
          --warning-bg: #664d03;
          --warning-text: #ffda6a;
          --warning-border: #997404;
          --textarea-bg: #2d2d2d;
        }
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
        /*background-color: var(--bg-color);*/
        color: var(--text-color);
      }

      h1 {
        color: var(--text-color);
        margin-bottom: 10px;
      }

      .info {
        color: var(--text-secondary);
        margin-bottom: 20px;
        font-size: 14px;
      }

      textarea {
        width: 100%;
        min-height: 300px;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-family: monospace;
        font-size: 14px;
        resize: vertical;
        background-color: var(--textarea-bg);
        color: var(--text-color);
      }

      button {
        margin-top: 16px;
        padding: 10px 20px;
        background-color: var(--button-bg);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: var(--button-hover);
      }

      button:active {
        transform: translateY(1px);
      }

      .example {
        margin-top: 30px;
        padding: 16px;
        background-color: var(--example-bg);
        border-radius: 4px;
        border: 1px solid var(--example-border);
      }

      .example h3 {
        margin-top: 0;
        color: var(--text-color);
      }

      .example pre {
        margin: 0;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .warning {
        color: var(--warning-text);
        background-color: var(--warning-bg);
        border: 1px solid var(--warning-border);
        padding: 12px;
        border-radius: 4px;
        margin-top: 20px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <h1>Markdown List to Task Converter</h1>

    <div class="info">
      Paste your markdown list below and click "Convert to Tasks" to create tasks in Super
      Productivity.
    </div>

    <textarea
      id="markdownInput"
      placeholder="Paste your markdown list here...

Example:
- Main task 1
  - Subtask 1.1
  - Subtask 1.2
- Main task 2
  - Subtask 2.1"
    ></textarea>

    <button onclick="convertList()">Convert to Tasks</button>

    <div class="warning">
      <strong>Note:</strong> Lists nested deeper than 2 levels will be converted to task
      notes as markdown checklists.
    </div>

    <div class="example">
      <h3>Example Input:</h3>
      <pre>
- Research project requirements
  - Review documentation
  - Interview stakeholders
    - Schedule meetings
    - Prepare questions
- Design system architecture
  - Create diagrams
  - Define components</pre
      >
    </div>

    <script>
      // Wait for PluginAPI to be available
      function waitForPluginAPI() {
        if (typeof PluginAPI !== 'undefined') {
          init();
        } else {
          setTimeout(waitForPluginAPI, 100);
        }
      }

      function init() {
        console.log('Markdown List to Task iframe initialized');
      }

      let hasDeepNesting = false;

      function parseMarkdownList(text) {
        const lines = text.split('\n');
        const tasks = [];
        const stack = [];
        hasDeepNesting = false;

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;

          const match = line.match(/^(\s*)([-*+]|\d+\.)\s+(.+)$/);
          if (!match) continue;

          const [, indent, bullet, content] = match;
          const level = Math.floor(indent.length / 2);

          if (level > 1) {
            hasDeepNesting = true;
            continue;
          }

          const task = {
            title: content.trim(),
            subTasks: [],
            deepNotes: [],
          };

          if (level === 0) {
            tasks.push(task);
            stack[0] = task;
            stack.length = 1;
          } else if (level === 1 && stack[0]) {
            stack[0].subTasks.push(task);
            stack[1] = task;
            stack.length = 2;
          }
        }

        if (hasDeepNesting) {
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (!line.trim()) continue;

            const match = line.match(/^(\s*)([-*+]|\d+\.)\s+(.+)$/);
            if (!match) continue;

            const [, indent, bullet, content] = match;
            const level = Math.floor(indent.length / 2);

            if (level > 1) {
              const parentLevel = level - 2;
              const parentTask = parentLevel === 0 ? stack[0] : stack[1];
              if (parentTask) {
                const checklistIndent = '  '.repeat(level - 2);
                parentTask.deepNotes.push(`${checklistIndent}- [ ] ${content.trim()}`);
              }
            }
          }
        }

        return tasks;
      }

      function createTasksFromParsedData(tasks) {
        const createdTasks = [];

        tasks.forEach((taskData) => {
          const taskConfig = {
            title: taskData.title,
            subTasks: [],
          };

          if (taskData.deepNotes.length > 0) {
            taskConfig.notes = taskData.deepNotes.join('\n');
          }

          if (taskData.subTasks.length > 0) {
            taskData.subTasks.forEach((subTask) => {
              const subTaskConfig = {
                title: subTask.title,
              };
              if (subTask.deepNotes.length > 0) {
                subTaskConfig.notes = subTask.deepNotes.join('\n');
              }
              taskConfig.subTasks.push(subTaskConfig);
            });
          }

          createdTasks.push(taskConfig);
        });

        return createdTasks;
      }

      async function convertList() {
        const textarea = document.getElementById('markdownInput');
        const text = textarea.value.trim();

        if (!text) {
          PluginAPI.showSnack({
            msg: 'Please enter a markdown list',
            type: 'ERROR',
          });
          return;
        }

        try {
          const parsedTasks = parseMarkdownList(text);

          if (parsedTasks.length === 0) {
            PluginAPI.showSnack({
              msg: 'No valid markdown list items found',
              type: 'ERROR',
            });
            return;
          }

          const tasksToCreate = createTasksFromParsedData(parsedTasks);
          let createdCount = 0;

          for (const taskConfig of tasksToCreate) {
            await PluginAPI.addTask(taskConfig);
            createdCount++;
          }

          if (hasDeepNesting) {
            PluginAPI.showSnack({
              msg: `Created ${createdCount} tasks. Warning: Items nested deeper than 2 levels were added as notes.`,
              type: 'CUSTOM',
            });
          } else {
            PluginAPI.showSnack({
              msg: `Successfully created ${createdCount} tasks`,
              type: 'SUCCESS',
            });
          }

          textarea.value = '';
        } catch (error) {
          console.error('Error converting markdown:', error);
          PluginAPI.showSnack({
            msg: 'Error creating tasks: ' + error.message,
            type: 'ERROR',
          });
        }
      }

      document.getElementById('markdownInput').addEventListener('keydown', function (e) {
        if (e.ctrlKey && e.key === 'Enter') {
          convertList();
        }
      });

      // Start initialization
      waitForPluginAPI();
    </script>
  </body>
</html>
