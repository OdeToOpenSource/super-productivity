<div class="wrapper">
  @if (!isNavAlwaysVisible()) {
    <button
      (click)="layoutService.toggleSideNav()"
      class="burger-trigger tour-burgerTrigger"
      mat-icon-button
    >
      <mat-icon>menu</mat-icon>
    </button>
  }

  @if (activeWorkContextTypeAndId()) {
    <div
      [matTooltip]="T.MH.GO_TO_TASK_LIST | translate"
      class="current-work-context-title"
      mat-ripple
      routerLink="/active/tasks"
    >
      {{ activeWorkContextTitle() }}
    </div>
    @if (!isXxxs()) {
      <button
        [mat-menu-trigger-for]="activeWorkContextMenu"
        [matTooltip]="T.MH.PROJECT_MENU | translate"
        class="project-settings-btn"
        mat-icon-button
      >
        <mat-icon>more_vert</mat-icon>
      </button>
    }
    <mat-menu #activeWorkContextMenu="matMenu">
      <ng-template matMenuContent>
        <work-context-menu
          [contextId]="activeWorkContextTypeAndId()!.activeId"
          [contextType]="activeWorkContextTypeAndId()!.activeType"
        ></work-context-menu>
      </ng-template>
    </mat-menu>
  }

  @if (isScheduleSection()) {
    <div class="week-month-selector">
      <button
        (click)="selectTimeView('week')"
        [class.active]="(selectedTimeView$ | async) === 'week'"
        class="week-month-btn week-btn"
        matTooltip="View Week"
        mat-button
      >
        {{ T.GCF.SCHEDULE.WEEK | translate }}
      </button>
      <button
        (click)="selectTimeView('month')"
        [class.active]="(selectedTimeView$ | async) === 'month'"
        class="week-month-btn month-btn"
        matTooltip="View Month"
        mat-button
      >
        {{ T.GCF.SCHEDULE.MONTH | translate }}
      </button>
    </div>
  }

  <nav class="action-nav">
    @if (showDesktopButtons()) {
      <button
        (click)="layoutService.showAddTaskBar()"
        matTooltip="{{ T.MH.ADD_NEW_TASK | translate }} {{
          kb.addNewTask ? '[' + kb.addNewTask + ']' : ''
        }}"
        class="tour-addBtn"
        mat-icon-button
      >
        <mat-icon>add</mat-icon>
      </button>
    }

    <button
      class="sync-btn"
      matTooltip="{{ T.MH.TRIGGER_SYNC | translate }}"
      (click)="syncIsEnabledAndReady() ? sync() : setupSync()"
      (longPress)="setupSync()"
      (contextmenu)="$event.preventDefault(); setupSync()"
      mat-icon-button
    >
      @if (syncIsEnabledAndReady()) {
        @if (isOnline()) {
          @if (syncState() === 'ERROR') {
            <mat-icon>sync_problem</mat-icon>
          } @else {
            <mat-icon [class.spin]="isSyncInProgress()">sync</mat-icon>
          }
          @if (syncState() === 'IN_SYNC') {
            <mat-icon class="sync-state-ico">check</mat-icon>
          }
        } @else {
          <mat-icon>wifi_off</mat-icon>
        }
      } @else {
        <mat-icon>sync_disabled</mat-icon>
      }
    </button>

    @if (!focusModeConfig()?.isAlwaysUseFocusMode) {
      @if (!isXxxs()) {
        <button
          mat-icon-button
          matTooltip="{{ T.MH.ENTER_FOCUS_MODE | translate }} {{
            kb.goToFocusMode ? '[' + kb.goToFocusMode + ']' : ''
          }}"
          (click)="enableFocusMode()"
        >
          <mat-icon>center_focus_strong</mat-icon>
        </button>
      }
    }

    <plugin-header-btns></plugin-header-btns>

    <div class="play-btn-wrapper">
      @if (currentTask(); as task) {
        <div
          @fade
          class="current-task-title"
        >
          <div class="title">{{ task.title }}</div>
          @if (currentTaskContext(); as taskContext) {
            <tag
              @expandFadeHorizontal
              [tag]="taskContext"
              class="project"
            ></tag>
          }
        </div>
      }
      @if (currentTaskId()) {
        <div class="pulse-circle"></div>
      }

      <button
        (click)="taskService.toggleStartTask()"
        [color]="currentTaskId() ? 'accent' : 'primary'"
        matTooltip="{{ T.MH.TOGGLE_TRACK_TIME | translate }}"
        [matTooltipPosition]="pomodoroIsEnabled() ? 'left' : 'below'"
        class="play-btn tour-playBtn mat-elevation-z3"
        mat-mini-fab
      >
        @if (pomodoroIsEnabled()) {
          @if (pomodoroIsBreak()) {
            <mat-icon>free_breakfast</mat-icon>
          } @else {
            @if (!currentTaskId()) {
              <mat-icon>play_arrow</mat-icon>
            } @else {
              <mat-icon>pause</mat-icon>
            }
          }
        } @else {
          @if (!currentTaskId()) {
            <mat-icon>play_arrow</mat-icon>
          } @else {
            <mat-icon>pause</mat-icon>
          }
        }

        <svg
          class="circle-svg"
          focusable="false"
          height="40"
          width="40"
        >
          <circle
            #circleSvg
            cx="50%"
            cy="50%"
            fill="none"
            r="10"
            stroke="#000"
            stroke-dasharray="81.6814089933"
            stroke-dashoffset="-81.6814089933"
            stroke-width="20"
          ></circle>
        </svg>
      </button>

      @if (pomodoroIsEnabled()) {
        <div class="pomodoro-label">
          {{ pomodoroCurrentSessionTime() | msToMinuteClockString }}
        </div>
        <div class="pomodoro-controls">
          <button
            (click)="pomodoroService.finishPomodoroSession()"
            [matTooltip]="T.F.POMODORO.S.SESSION_SKIP | translate"
            matTooltipPosition="left"
            class="pomodoro-btn"
            color=""
            mat-mini-fab
          >
            <mat-icon>skip_next</mat-icon>
          </button>
          <button
            (click)="pomodoroService.stop()"
            [matTooltip]="T.F.POMODORO.S.RESET | translate"
            matTooltipPosition="left"
            class="pomodoro-btn"
            color=""
            mat-mini-fab
          >
            <mat-icon>restart_alt</mat-icon>
          </button>
        </div>
      }
    </div>

    <!-- Desktop: Show all buttons inline -->
    @if (showDesktopButtons()) {
      <!-- Simple counter buttons -->
      @for (
        simpleCounter of enabledSimpleCounters();
        track trackById($index, simpleCounter)
      ) {
        <simple-counter-button
          [matTooltip]="simpleCounter.title"
          [simpleCounter]="simpleCounter"
        ></simple-counter-button>
      }

      <plugin-side-panel-btns></plugin-side-panel-btns>

      <button
        class="panel-btn"
        [disabled]="!isRouteWithSidePanel()"
        [class.isActive]="isShowTaskViewCustomizerPanel()"
        [class.isCustomized]="taskViewCustomizerService.isCustomized()"
        (click)="layoutService.toggleTaskViewCustomizerPanel()"
        mat-icon-button
        matTooltip="{{ T.GCF.KEYBOARD.TOGGLE_TASK_VIEW_CUSTOMIZER_PANEL | translate }} {{
          kb.toggleTaskViewCustomizerPanel
            ? '[' + kb.toggleTaskViewCustomizerPanel + ']'
            : ''
        }}"
      >
        <mat-icon>filter_list</mat-icon>
      </button>

      <button
        class="panel-btn e2e-toggle-issue-provider-panel"
        [disabled]="!isRouteWithSidePanel()"
        [class.isActive]="isShowIssuePanel()"
        (click)="layoutService.toggleAddTaskPanel()"
        mat-icon-button
        matTooltip="{{ T.MH.TOGGLE_SHOW_ISSUE_PANEL | translate }} {{
          kb.toggleIssuePanel ? '[' + kb.toggleIssuePanel + ']' : ''
        }}"
      >
        <mat-icon>playlist_add</mat-icon>
      </button>

      <button
        class="panel-btn e2e-toggle-notes-btn"
        [disabled]="!isRouteWithSidePanel()"
        [class.isActive]="isShowNotes()"
        (click)="layoutService.toggleNotes()"
        mat-icon-button
        matTooltip="{{ T.MH.TOGGLE_SHOW_NOTES | translate }} {{
          kb.openProjectNotes ? '[' + kb.openProjectNotes + ']' : ''
        }}"
      >
        <mat-icon>comment</mat-icon>
      </button>
    }

    <!-- Mobile: Show dropdown menus -->
    @if (isXs()) {
      <!-- Simple counter mobile dropdown -->
      @if (enabledSimpleCounters().length) {
        <div class="mobile-dropdown-wrapper">
          <button
            (click)="isShowSimpleCounterBtnsMobile.set(!isShowSimpleCounterBtnsMobile())"
            [color]="isCounterRunning(enabledSimpleCounters()) ? 'accent' : ''"
            mat-icon-button
          >
            <mat-icon>{{ isShowSimpleCounterBtnsMobile() ? 'close' : 'timer' }}</mat-icon>
          </button>
          <div
            class="mobile-dropdown"
            [class.isVisible]="isShowSimpleCounterBtnsMobile()"
          >
            @for (
              simpleCounter of enabledSimpleCounters();
              track trackById($index, simpleCounter)
            ) {
              <simple-counter-button
                [simpleCounter]="simpleCounter"
              ></simple-counter-button>
            }
          </div>
        </div>
      }

      <mobile-side-panel-menu></mobile-side-panel-menu>
    }
  </nav>
</div>
